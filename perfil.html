<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tu perfil - Natural Power</title>
  <link rel="stylesheet" href="css/style.css"/>
  <style>
    .nav-user-badge{font-weight:600;color:#2e7d32}
    .nav-sep{opacity:.35;margin:0 .35rem}

    .perfil-wrapper{
      max-width:900px;
      margin:2.5rem auto;
      background:#fff;
      border-radius:16px;
      padding:1.8rem 2rem 2.2rem;
      box-shadow:0 8px 25px rgba(15,23,42,.08);
    }
    .perfil-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:1rem;
      margin-bottom:1.3rem;
    }
    .perfil-header h1{margin:0;font-size:1.7rem;}
    .perfil-sub{margin:.15rem 0 .4rem;font-size:.95rem;color:#555;}
    .perfil-meta{font-size:.9rem;color:#666;}

    .perfil-address{
      margin:1.5rem 0;
      padding:1rem 1.2rem;
      border-radius:12px;
      background:#f9fafb;
      border:1px solid #e5e7eb;
    }
    .perfil-address-title{font-weight:600;margin:0 0 .25rem;}
    .perfil-address-input{
      width:100%;
      min-height:70px;
      resize:vertical;
      border-radius:8px;
      border:1px solid #d1d5db;
      padding:8px;
      margin:.35rem 0 .75rem;
      font-family:inherit;
      font-size:.95rem;
    }
    .perfil-address-actions{
      display:flex;
      align-items:center;
      flex-wrap:wrap;
      gap:.75rem;
    }
    .perfil-message{
      font-size:.85rem;
      color:#555;
    }
    .perfil-divider{
      border:none;
      border-top:1px solid #e5e7eb;
      margin:1.5rem 0;
    }

    table{
      width:100%;
      border-collapse:collapse;
      margin-top:.5rem;
    }
    th,td{
      padding:8px 10px;
      border-bottom:1px solid #eee;
      font-size:.92rem;
    }
    th{background:#f7f7f7;text-align:left;}
    .empty-msg{
      text-align:center;
      padding:1rem 0;
      color:#555;
      font-size:.93rem;
    }
    .badge-status{
      display:inline-block;
      padding:2px 10px;
      border-radius:999px;
      background:#dcfce7;
      color:#166534;
      font-size:.8rem;
      font-weight:600;
    }
    .btn-sm{
      padding:4px 10px;
      border-radius:6px;
      border:1px solid #d4d4d8;
      background:#f4f4f5;
      font-size:.8rem;
      cursor:pointer;
    }
    .btn-sm:hover{background:#e4e4e7;}

    /* Modal */
    .modal{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.65);
      display:flex;
      justify-content:center;
      align-items:center;
      z-index:999;
    }
    .modal.hidden{display:none;}
    .modal-content{
      background:#fff;
      border-radius:14px;
      padding:1.5rem 1.8rem;
      max-width:600px;
      width:90%;
      box-shadow:0 10px 35px rgba(0,0,0,.35);
    }
    .modal-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:.5rem;
    }
    .modal-close{
      border:none;
      background:none;
      font-size:1.4rem;
      cursor:pointer;
    }
    .modal-meta{
      font-size:.9rem;
      color:#555;
      margin-bottom:.25rem;
    }
    .modal-address{
      font-size:.9rem;
      color:#555;
      margin-bottom:.45rem;
    }
    .modal-total{
      font-weight:600;
      margin-bottom:.6rem;
    }
  </style>
</head>
<body>
<header>
  <div class="container">
    <nav class="navbar">
      <div class="logo">Natural Power</div>
      <ul class="nav-links">
        <li><a href="index.html">Inicio</a></li>
        <li><a href="productos.html">Men√∫</a></li>

        <li><a href="perfil.html" class="active" id="nav-profile">Perfil</a></li>

        <li>
          <span id="nav-user-email" class="nav-user-badge" style="display:none;"></span>
          <span class="nav-sep" id="nav-sep" style="display:none;">¬∑</span>
          <a href="login.html" id="nav-login">Iniciar Sesi√≥n</a>
          <a href="#" id="nav-logout" style="display:none;">Salir</a>
        </li>

        <li><a href="carrito.html">üõí Carrito</a></li>
      </ul>
    </nav>
  </div>
</header>

<main>
  <section class="perfil-wrapper">
    <div class="perfil-header">
      <div>
        <h1>Tu perfil</h1>
        <p class="perfil-sub">Historial de compras</p>
      </div>
      <div class="perfil-meta">
        Sesi√≥n con: <span id="perfil-email">-</span>
      </div>
    </div>

    <!-- Direcci√≥n -->
    <div class="perfil-address">
      <h3 class="perfil-address-title">Direcci√≥n de env√≠o</h3>
      <p class="perfil-sub">Esta direcci√≥n se usar√° por defecto al realizar tus pedidos.</p>

      <textarea
        id="shipping-address"
        class="perfil-address-input"
        placeholder="Ej: Calle 1234, Depto 45, Santiago"
        rows="3"
      ></textarea>

      <div class="perfil-address-actions">
        <button id="btn-save-address" class="btn-sm">Guardar direcci√≥n</button>
        <span id="address-status" class="perfil-message"></span>
      </div>
    </div>

    <hr class="perfil-divider"/>

    <!-- Tabla de pedidos -->
    <h2 style="margin-bottom:.4rem;">Historial de pedidos</h2>
    <div class="table-wrapper">
      <table>
        <thead>
        <tr>
          <th>#</th>
          <th>ID Pedido</th>
          <th>Correo</th>
          <th>Fecha</th>
          <th>Total</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
        </thead>
        <tbody id="orders-body">
        <tr>
          <td colspan="7" class="empty-msg">Cargando pedidos...</td>
        </tr>
        </tbody>
      </table>
    </div>
  </section>
</main>

<footer>
  <div class="container">
    <p>&copy; 2025 Natural Power. Todos los derechos reservados.</p>
  </div>
</footer>

<!-- Modal detalle pedido -->
<div id="modal" class="modal hidden">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="modal-title">Pedido</h3>
      <button id="modal-close" class="modal-close">&times;</button>
    </div>
    <p id="modal-meta" class="modal-meta"></p>
    <p id="modal-address" class="modal-address"></p>
    <p id="modal-total" class="modal-total"></p>

    <table>
      <thead>
      <tr>
        <th>Producto</th>
        <th>Cantidad</th>
        <th>Precio</th>
        <th>Subtotal</th>
      </tr>
      </thead>
      <tbody id="modal-body">
      <tr><td colspan="4">Cargando...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script src="js/auth.js"></script>
<script>
  const CLP = new Intl.NumberFormat('es-CL',{style:'currency',currency:'CLP',maximumFractionDigits:0});
  const API = window.API_BASE || (localStorage.getItem('API_BASE') || 'http://127.0.0.1:8000');

  // ---------- Navbar ----------
  function renderSessionUI(){
    const u = Auth.currentUser();
    const login = document.getElementById('nav-login');
    const logout = document.getElementById('nav-logout');
    const emailBadge = document.getElementById('nav-user-email');
    const sep = document.getElementById('nav-sep');

    if (u) {
      emailBadge.textContent = u.email;
      emailBadge.style.display = 'inline';
      sep.style.display = 'inline';
      login.style.display = 'none';
      logout.style.display = 'inline';
    } else {
      emailBadge.style.display = 'none';
      sep.style.display = 'none';
      login.style.display = 'inline';
      logout.style.display = 'none';
    }

    const pe = document.getElementById('perfil-email');
    if (pe) pe.textContent = u?.email || '-';
  }

  document.getElementById('nav-logout').addEventListener('click', async (e)=>{
    e.preventDefault();
    await Auth.logout();
    renderSessionUI();
    window.location.href = "login.html";
  });

  // ---------- Direcci√≥n de env√≠o ----------
  async function cargarDireccionEnvio(){
    const u = Auth.currentUser();
    const textarea = document.getElementById("shipping-address");
    const status = document.getElementById("address-status");
    if (!textarea || !u) {
      if (status) status.textContent = "Inicia sesi√≥n para gestionar tu direcci√≥n.";
      return;
    }

    try {
      const res = await fetch(`${API}/api/auth/user/${u.id}`);
      if (!res.ok) return;
      const data = await res.json();
      if (data && data.shipping_address) textarea.value = data.shipping_address;
    } catch (err) {
      console.error("No se pudo cargar direcci√≥n:", err);
      if (status) status.textContent = "No se pudo cargar la direcci√≥n.";
    }
  }

  async function guardarDireccionEnvio(){
    const u = Auth.currentUser();
    const textarea = document.getElementById("shipping-address");
    const status = document.getElementById("address-status");

    if (!u) {
      alert("Debes iniciar sesi√≥n para guardar una direcci√≥n.");
      return;
    }
    const shipping_address = (textarea.value || "").trim();
    if (!shipping_address) {
      alert("Ingresa una direcci√≥n de env√≠o.");
      return;
    }

    try {
      const res = await fetch(`${API}/api/auth/user/${u.id}/address`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ shipping_address }),
      });
      if (!res.ok) throw new Error("Error HTTP " + res.status);

      if (status) {
        status.textContent = "Direcci√≥n guardada ‚úÖ";
        setTimeout(() => status.textContent = "", 3000);
      }
    } catch (err) {
      console.error("Error guardando direcci√≥n:", err);
      alert("No se pudo guardar la direcci√≥n.");
    }
  }

  document.getElementById("btn-save-address").addEventListener("click", guardarDireccionEnvio);

  // ---------- Pedidos ----------
  async function cargarPedidos(){
    const u = Auth.currentUser();
    const tbody = document.getElementById('orders-body');
    if (!tbody) return;

    if (!u) {
      tbody.innerHTML = '<tr><td colspan="7" class="empty-msg">Debes iniciar sesi√≥n para ver tus pedidos.</td></tr>';
      return;
    }

    const email = u.email;

    try{
      const res = await fetch(`${API}/api/orders/by-email/${encodeURIComponent(email)}`);
      if (!res.ok) {
        const txt = await res.text();
        console.error("Error backend pedidos:", res.status, txt);
        throw new Error("Respuesta no OK");
      }
      const data = await res.json();

      if (!data.length) {
        tbody.innerHTML = '<tr><td colspan="7" class="empty-msg">A√∫n no tienes pedidos realizados.</td></tr>';
        return;
      }

      tbody.innerHTML = data.map((p, idx)=>`
        <tr data-id="${p.id}">
          <td>${idx + 1}</td>
          <td>#${p.id}</td>
          <td>${p.email}</td>
          <td>${p.created_at ? new Date(p.created_at).toLocaleString() : '-'}</td>
          <td>${CLP.format(p.total)}</td>
          <td><span class="badge-status">Completado</span></td>
          <td><button class="btn-sm btn-detalle" data-id="${p.id}">Ver detalle</button></td>
        </tr>
      `).join("");

      // guardamos en cach√© global para el modal
      window.__ORDERS_CACHE = data;

    } catch(err){
      console.error("Fallo al cargar pedidos:", err);
      tbody.innerHTML = '<tr><td colspan="7" class="empty-msg">No se pudieron cargar tus pedidos.</td></tr>';
    }
  }

  // ---- Modal ----
  function abrirModal(id){
    const pedidos = window.__ORDERS_CACHE || [];
    const p = pedidos.find(x => x.id === id);
    if (!p) return;

    document.getElementById('modal-title').textContent = `Pedido #${p.id}`;
    document.getElementById('modal-meta').textContent =
      `Realizado por ${p.email} el ${p.created_at ? new Date(p.created_at).toLocaleString() : '-'}`;

    const dir = p.shipping_address && p.shipping_address.trim()
      ? p.shipping_address
      : 'Sin direcci√≥n registrada para este pedido.';

    document.getElementById('modal-address').textContent = `Direcci√≥n de env√≠o: ${dir}`;
    document.getElementById('modal-total').textContent = `Total: ${CLP.format(p.total)}`;

    const tbody = document.getElementById('modal-body');
    if (!p.items || !p.items.length) {
      tbody.innerHTML = '<tr><td colspan="4">No hay detalle de productos disponible para este pedido.</td></tr>';
    } else {
      tbody.innerHTML = p.items.map(it => `
        <tr>
          <td>${it.product_name}</td>
          <td>${it.qty}</td>
          <td>${CLP.format(it.unit_price)}</td>
          <td>${CLP.format(it.subtotal)}</td>
        </tr>
      `).join("");
    }

    document.getElementById('modal').classList.remove('hidden');
  }

  document.getElementById('modal-close').addEventListener('click', () => {
    document.getElementById('modal').classList.add('hidden');
  });

  document.addEventListener('click', (e)=>{
    if (e.target.classList.contains('btn-detalle')) {
      const id = parseInt(e.target.dataset.id, 10);
      abrirModal(id);
    }
  });

  document.addEventListener('DOMContentLoaded', ()=>{
    renderSessionUI();
    cargarDireccionEnvio();
    cargarPedidos();
  });
</script>
</body>
</html>
