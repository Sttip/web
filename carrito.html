<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Carrito de Compras</title>
  <link rel="stylesheet" href="css/style.css"/>
  <style>
    .cart-table{width:100%;border-collapse:collapse;margin-top:1rem;background:#fff;border-radius:10px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,.06)}
    .cart-table th,.cart-table td{padding:12px 14px;border-bottom:1px solid:#eee;text-align:left}
    .cart-table th{background:#f7f7f7;font-weight:600;color:#333}
    .cart-row:last-child td{border-bottom:none}
    .qty-control{display:inline-flex;align-items:center;gap:6px;border:1px solid:#ddd;border-radius:8px;padding:4px;background:#fafafa}
    .qty-btn{width:30px;height:30px;display:inline-flex;align-items:center;justify-content:center;border:none;border-radius:6px;background:#e9e9e9;cursor:pointer;font-weight:700}
    .qty-btn:hover{background:#dfdfdf}
    .qty-input{width:48px;text-align:center;border:none;background:transparent;outline:none;font-weight:600}
    .remove-btn{background:#ef4444;color:#fff;border:none;padding:8px 10px;border-radius:8px;cursor:pointer}
    .remove-btn:hover{background:#dc2626}
    .carrito-total{text-align:right;margin-top:1rem;font-weight:bold;font-size:1.05rem}
    .primary-btn{padding:10px 14px;border:none;border-radius:8px;background:#06d6a0;color:#fff;cursor:pointer;font-weight:600}
    .primary-btn:hover{background:#04b384}
    input[type="email"]{width:100%;max-width:520px;padding:10px;border:1px solid:#ccc;border-radius:8px;margin:.5rem 0 1rem}
    .nav-user-badge{font-weight:600;color:#2e7d32}
    .nav-sep{opacity:.35;margin:0 .35rem}

    /* Modal de √©xito */
    .modal-exito {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.65);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      backdrop-filter: blur(2px);
    }
    .modal-exito.hidden {
      display: none;
    }
    .modal-exito-box {
      background: #ffffff;
      padding: 2rem 2.5rem;
      border-radius: 16px;
      text-align: center;
      max-width: 380px;
      width: 90%;
      box-shadow: 0 6px 25px rgba(0,0,0,0.25);
      animation: fadeUp .35s ease;
    }
    .modal-exito-box h3 {
      font-size: 1.4rem;
      font-weight: 800;
      margin-bottom: .5rem;
      color: #2e7d32;
    }
    .modal-exito-box p {
      color: #444;
      margin-bottom: 1.2rem;
      font-size: 1rem;
    }
    #btn-exito-ok {
      background: #2e7d32;
      color: #fff;
      border: none;
      padding: 10px 18px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
    }
    #btn-exito-ok:hover {
      background: #256b29;
    }
    @keyframes fadeUp {
      from { opacity:0; transform: translateY(20px); }
      to   { opacity:1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="container">
      <nav class="navbar">
        <div class="logo">Natural Power</div>
        <ul class="nav-links">
          <li><a href="index.html">Inicio</a></li>
          <li><a href="productos.html">Men√∫</a></li>

          <!-- PERFIL: s√≥lo se muestra logeado -->
          <li><a href="perfil.html" id="nav-profile" style="display:none;">Perfil</a></li>

          <li>
            <span id="nav-user-email" class="nav-user-badge" style="display:none;"></span>
            <span class="nav-sep" id="nav-sep" style="display:none;">¬∑</span>
            <a href="login.html" id="nav-login">Iniciar Sesi√≥n</a>
            <a href="#" id="nav-logout" style="display:none;">Salir</a>
          </li>

          <li><a href="carrito.html" class="active">üõí Carrito</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <!-- Carrito -->
  <section class="container">
    <h2>Tu Carrito</h2>
    <div id="carrito-lista"></div>
    <div class="carrito-total" id="carrito-total"></div>

    <div style="margin-top: 2rem;">
      <h3>Finalizar compra</h3>
      <input type="email" id="email" placeholder="Tu correo electr√≥nico" required/>
      <div>
        <button id="btn-comprar" class="primary-btn">Confirmar pedido</button>
      </div>
    </div>
  </section>

  <!-- Modal de √©xito -->
  <div id="modal-exito" class="modal-exito hidden">
    <div class="modal-exito-box">
      <h3>‚ú® Compra realizada con √©xito</h3>
      <p>Gracias por tu pedido üíö</p>
      <button id="btn-exito-ok">Aceptar</button>
    </div>
  </div>

  <!-- Footer -->
  <footer>
    <div class="container">
      <p>&copy; 2025 Natural Power. Todos los derechos reservados.</p>
    </div>
  </footer>

  <!-- auth.js define window.API_BASE y window.Auth -->
  <script src="js/auth.js"></script>

  <script>
    // ---------- Navbar: sesi√≥n ----------
    function renderSessionUI(){
      const u = Auth.currentUser();
      const login = document.getElementById('nav-login');
      const logout = document.getElementById('nav-logout');
      const emailBadge = document.getElementById('nav-user-email');
      const sep = document.getElementById('nav-sep');
      const profile = document.getElementById('nav-profile');

      if (u) {
        emailBadge.textContent = u.email;
        emailBadge.style.display = 'inline';
        sep.style.display = 'inline';
        login.style.display = 'none';
        logout.style.display = 'inline';
        if (profile) profile.style.display = 'inline';
      } else {
        emailBadge.style.display = 'none';
        sep.style.display = 'none';
        login.style.display = 'inline';
        logout.style.display = 'none';
        if (profile) profile.style.display = 'none';
      }
    }

    document.getElementById('nav-logout').addEventListener('click', async (e)=>{
      e.preventDefault();
      await Auth.logout();
      renderSessionUI();
      applySessionEmail(); // refresca input
    });

    // ---------- Carrito ----------
    const CLP = new Intl.NumberFormat("es-CL", {
      style: "currency",
      currency: "CLP",
      maximumFractionDigits: 0,
    });
    const KEY = "carrito";
    const obtenerCarrito = () => JSON.parse(localStorage.getItem(KEY) || "[]");
    const guardarCarrito  = (c) => localStorage.setItem(KEY, JSON.stringify(c));

    function setCantidad(id, qty) {
      let carrito = obtenerCarrito();
      const i = carrito.findIndex(p => p.id === id);
      if (i === -1) return;
      const n = Math.max(0, parseInt(qty || 0, 10));
      if (n === 0) carrito.splice(i, 1);
      else carrito[i].qty = n;
      guardarCarrito(carrito);
      renderizarCarrito();
    }

    function eliminarDelCarrito(id) {
      let carrito = obtenerCarrito().filter(p => p.id !== id);
      guardarCarrito(carrito);
      renderizarCarrito();
    }

    function renderizarCarrito() {
      const cont = document.getElementById("carrito-lista");
      const totalDiv = document.getElementById("carrito-total");
      const carrito = obtenerCarrito();

      if (!carrito.length) {
        cont.innerHTML = "<p>Tu carrito est√° vac√≠o.</p>";
        totalDiv.textContent = "";
        return;
      }

      let total = 0;
      const rows = carrito.map(item => {
        const subtotal = item.qty * item.price;
        total += subtotal;
        return `
          <tr class="cart-row" data-id="${item.id}">
            <td>${item.name}</td>
            <td>
              <div class="qty-control">
                <button class="qty-btn qty-dec" aria-label="Disminuir">-</button>
                <input type="number" min="1" class="qty-input" value="${item.qty}">
                <button class="qty-btn qty-inc" aria-label="Aumentar">+</button>
              </div>
            </td>
            <td>${CLP.format(item.price)}</td>
            <td class="cell-subtotal">${CLP.format(subtotal)}</td>
            <td><button class="remove-btn">‚ùå</button></td>
          </tr>
        `;
      }).join("");

      cont.innerHTML = `
        <table class="cart-table">
          <thead>
            <tr>
              <th>Producto</th>
              <th style="width:170px;">Cantidad</th>
              <th>Precio</th>
              <th>Subtotal</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            ${rows}
          </tbody>
        </table>
      `;
      totalDiv.textContent = `Total: ${CLP.format(total)}`;
    }

    document.addEventListener("click", (e) => {
      const row = e.target.closest(".cart-row");
      if (!row) return;
      const id = parseInt(row.dataset.id, 10);

      if (e.target.classList.contains("qty-inc")) {
        const input = row.querySelector(".qty-input");
        setCantidad(id, parseInt(input.value || "1", 10) + 1);
      }
      if (e.target.classList.contains("qty-dec")) {
        const input = row.querySelector(".qty-input");
        setCantidad(id, parseInt(input.value || "1", 10) - 1);
      }
      if (e.target.classList.contains("remove-btn")) {
        eliminarDelCarrito(id);
      }
    });

    document.addEventListener("change", (e) => {
      if (!e.target.classList.contains("qty-input")) return;
      const row = e.target.closest(".cart-row");
      const id = parseInt(row.dataset.id, 10);
      setCantidad(id, e.target.value);
    });

    // --- email desde sesi√≥n ---
    function applySessionEmail(){
      const input = document.getElementById('email');
      const u = Auth.currentUser();
      if (u?.email) {
        input.value = u.email;
        input.readOnly = true;
        input.style.opacity = .7;
        input.title = 'Usando tu correo de sesi√≥n';
      } else {
        input.readOnly = false;
        input.style.opacity = 1;
        input.title = '';
      }
    }

    // --- Modal de √©xito ---
    function mostrarMensajeExito() {
      const modal = document.getElementById("modal-exito");
      modal.classList.remove("hidden");
      document.getElementById("btn-exito-ok").onclick = () => {
        modal.classList.add("hidden");
      };
    }

    // --- Checkout ---
    async function confirmarCompra() {
      try {
        const u = Auth.currentUser();
        const email = (u && u.email) || document.getElementById("email").value.trim();
        const carrito = obtenerCarrito();

        if (!email) { alert("Por favor, ingresa tu correo electr√≥nico."); return; }
        if (!carrito.length) { alert("Tu carrito est√° vac√≠o."); return; }

        const items = carrito.map(i => ({ product_id: i.id, qty: i.qty }));
        const total = carrito.reduce((s, i) => s + i.qty * i.price, 0);

        const res = await fetch(API_BASE + "/api/orders/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, items }),
        });

        if (!res.ok) {
          const txt = await res.text().catch(() => "");
          console.error("Respuesta no OK al crear pedido:", res.status, txt);
          alert("‚ùå No se pudo completar el pedido.");
          return;
        }

        const data = await res.json();
        console.log("Pedido creado:", data);

        // Modal bonito en lugar de alert
        mostrarMensajeExito();

        localStorage.removeItem(KEY);
        renderizarCarrito();
      } catch (err) {
        console.error("Error en confirmarCompra:", err);
        alert("‚ùå No se pudo completar el pedido.");
      }
    }

    document.getElementById("btn-comprar").addEventListener("click", confirmarCompra);

    document.addEventListener("DOMContentLoaded", ()=>{
      renderSessionUI();
      renderizarCarrito();
      applySessionEmail();
    });
  </script>
</body>
</html>
