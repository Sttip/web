<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Nuestros Smoothies</title>
  <link rel="stylesheet" href="css/style.css"/>
  <style>
    body { background:#f8f9fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color:#333; margin:0; }
    header { background:#fff; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
    .navbar { display:flex; justify-content:space-between; align-items:center; padding:1rem 2rem; }
    .logo { font-weight:700; font-size:1.3rem; color:#2e7d32; }
    .nav-links { list-style:none; display:flex; gap:1.5rem; margin:0; padding:0; align-items:center; }
    .nav-links a { text-decoration:none; color:#333; font-weight:500; }
    .nav-links a.active { color:#2e7d32; font-weight:600; }
    .nav-user-badge{font-weight:600;color:#2e7d32;}
    .nav-sep{opacity:.35;margin:0 .35rem;}

    .smoothies-section { padding:3rem 2rem; text-align:center; }
    .section-title { font-size:2rem; font-weight:800; margin-bottom:1rem; color:#222; }

    .catalog-toolbar {
      margin:1rem 0 2rem;
      text-align:center;
      display:flex;
      justify-content:center;
      gap:.75rem;
      flex-wrap:wrap;
    }
    #search {
      width:60%;
      max-width:400px;
      padding:10px;
      border-radius:8px;
      border:1px solid #ccc;
      outline:none;
    }
    #search:focus {
      border-color:#2e7d32;
      box-shadow:0 0 0 1px #2e7d32;
    }
    #filter-type{
      padding:10px;
      border-radius:8px;
      border:1px solid #ccc;
      outline:none;
      background:#fff;
      min-width:180px;
    }
    #filter-type:focus{
      border-color:#2e7d32;
      box-shadow:0 0 0 1px #2e7d32;
    }

    .smoothies-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(260px, 1fr)); gap:1.8rem; justify-items:center; }
    .smoothie-card { background:#fff; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,0.1); overflow:hidden; width:100%; max-width:300px; text-align:left; transition:transform .2s ease; }
    .smoothie-card:hover { transform: translateY(-5px); }

    .smoothie-color { height:120px; cursor:pointer; }
    .smoothie-info { padding:1.2rem; }
    .smoothie-name { font-size:1.2rem; font-weight:800; margin:0 0 .5rem 0; cursor:pointer; }
    .smoothie-desc { font-size:.95rem; color:#555; margin-bottom:1rem; }
    .smoothie-price { font-weight:800; color:#2e7d32; margin-bottom:.8rem; }
    .add-to-cart { background:#2e7d32; color:#fff; border:none; border-radius:8px; padding:10px; width:100%; font-weight:700; cursor:pointer; transition:background .2s ease; }
    .add-to-cart:hover { background:#256b29; }
    .add-to-cart[disabled]{ background:#c2c2c2; cursor:not-allowed; color:#555; }

    footer { background:#2b2b2b; color:#fff; text-align:center; padding:1rem 0; font-size:.9rem; margin-top:3rem; }

    /* Modal */
    .modal{ position:fixed; inset:0; background:rgba(0,0,0,.75); display:flex; justify-content:center; align-items:center; z-index:999; backdrop-filter:blur(4px); }
    .modal.hidden{ display:none; }
    .modal-content{ background:#1f1f1f; color:#fff; display:flex; flex-direction:row; border-radius:16px; padding:2rem; max-width:900px; width:90%; position:relative; box-shadow:0 4px 30px rgba(0,0,0,.5); }
    .modal-close{ position:absolute; top:1rem; right:1.5rem; background:none; border:none; color:#fff; font-size:1.8rem; cursor:pointer; }
    .modal-left{ flex:1 1 250px; display:flex; justify-content:center; align-items:center; padding-right:1rem; }
    .modal-right{ flex:2 1 400px; display:flex; flex-direction:column; justify-content:space-between; }
    .modal-img{ width:230px; height:230px; border-radius:20px; box-shadow:0 0 20px rgba(0,0,0,.4); }
    .modal-right h2{ font-size:1.8rem; margin:.2rem 0 .3rem; font-weight:900; }
    #modal-stock{ font-size:.9rem; padding:3px 10px; border-radius:8px; margin-left:8px; }
    .tabs{ display:flex; gap:.8rem; margin:1rem 0; }
    .tab{ background:#2c2c2c; border:1px solid #333; padding:.5rem 1rem; border-radius:8px; cursor:pointer; color:#ddd; transition:.2s; }
    .tab:hover{ background:#383838; }
    .tab.active{ border-color:#22c55e; color:#22c55e; background:#242424; }
    .tab-content{ background:#2b2b2b; padding:1rem; border-radius:8px; margin-bottom:1rem; font-size:.95rem; color:#e5e5e5; }
    #modal-add{ width:100%; padding:12px; font-size:1rem; }

    /* Toast */
    .toast{ position:fixed; right:20px; bottom:20px; background:#22c55e; color:#fff; padding:10px 16px; border-radius:10px; font-weight:700; box-shadow:0 10px 25px rgba(0,0,0,.25); animation:toast 2s ease forwards; z-index:1000;}
    .toast.error{ background:#dc2626; }
    @keyframes toast{ 0%{opacity:0; transform:translateY(10px)} 10%,90%{opacity:1; transform:translateY(0)} 100%{opacity:0; transform:translateY(10px)} }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <nav class="navbar">
        <div class="logo">Natural Power</div>
        <ul class="nav-links">
          <li><a href="index.html">Inicio</a></li>
          <li><a href="productos.html" class="active">Men√∫</a></li>

          <!-- PERFIL: s√≥lo se muestra logeado -->
          <li><a href="perfil.html" id="nav-profile" style="display:none;">Perfil</a></li>

          <li>
            <span id="nav-user-email" class="nav-user-badge" style="display:none;"></span>
            <span class="nav-sep" id="nav-sep" style="display:none;">¬∑</span>
            <a href="login.html" id="nav-login">Iniciar Sesi√≥n</a>
            <a href="#" id="nav-logout" style="display:none;">Salir</a>
          </li>

          <li><a href="carrito.html">üõí Carrito</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <section class="smoothies-section">
    <h2 class="section-title">Nuestros Smoothies</h2>
    <div class="catalog-toolbar">
      <input
        id="search"
        type="search"
        placeholder="Buscar smoothies por nombre o descripci√≥n..."
      />
      <select id="filter-type">
        <option value="all">Todos los tipos</option>
        <option value="jugos_detox">Jugos Detox</option>
        <option value="smoothies_frutales">Smoothies frutales</option>
        <option value="smoothies_proteicos">Smoothies proteicos</option>
        <option value="smoothies_verdes">Smoothies verdes</option>
      </select>
    </div>
    <div class="smoothies-grid" id="smoothies-grid">
      <p>Cargando smoothies...</p>
    </div>
  </section>

  <!-- Modal -->
  <div id="modal-detalle" class="modal hidden" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true">
      <button id="modal-cerrar" class="modal-close" aria-label="Cerrar">&times;</button>
      <div class="modal-left">
        <div id="modal-imagen" class="modal-img"></div>
      </div>
      <div class="modal-right">
        <div>
          <h2 id="modal-nombre"></h2>
          <p><strong id="modal-precio"></strong><span id="modal-stock"></span></p>
          <p id="modal-descripcion"></p>

          <div class="tabs">
            <button class="tab active" data-tab="ingredientes">Ingredientes</button>
            <button class="tab" data-tab="beneficios">Beneficios</button>
            <button class="tab" data-tab="nutricion">Informaci√≥n Nutricional</button>
          </div>
          <div class="tab-content" id="tab-contenido"></div>
        </div>
        <button id="modal-add" class="add-to-cart">Agregar al Carrito</button>
      </div>
    </div>
  </div>

  <footer>
    <div class="container"><p>&copy; 2025 Natural Power. Todos los derechos reservados.</p></div>
  </footer>

  <!-- üëá IMPORTANTE: auth.js primero -->
  <script src="js/auth.js"></script>

  <script>
    // ==========================
    // Navbar: sesi√≥n
    // ==========================
    function renderSessionUI(){
      const u = Auth.currentUser();
      const login = document.getElementById('nav-login');
      const logout = document.getElementById('nav-logout');
      const emailBadge = document.getElementById('nav-user-email');
      const sep = document.getElementById('nav-sep');
      const profile = document.getElementById('nav-profile');

      if (u) {
        emailBadge.textContent = u.email;
        emailBadge.style.display = 'inline';
        sep.style.display = 'inline';
        login.style.display = 'none';
        logout.style.display = 'inline';
        if (profile) profile.style.display = 'inline';
      } else {
        emailBadge.style.display = 'none';
        sep.style.display = 'none';
        login.style.display = 'inline';
        logout.style.display = 'none';
        if (profile) profile.style.display = 'none';
      }
    }

    document.getElementById('nav-logout').addEventListener('click', async (e)=>{
      e.preventDefault();
      await Auth.logout();
      renderSessionUI();
    });

    // ==========================
    // Config & helpers
    // ==========================
    const API_URL = "http://127.0.0.1:8000/api/products";
    const CACHE_KEY = "cache_products_v1";
    const CACHE_TS_KEY = "cache_products_v1_ts";
    const CLP = new Intl.NumberFormat('es-CL',{style:'currency',currency:'CLP',maximumFractionDigits:0});

    // Guardamos todos los productos cargados
    let ALL_PRODUCTS = [];
    let MODE_PRODUCTS = "live";
    let CURRENT_PRODUCT = null; // producto mostrado en el modal

    // Fallback (demo) siempre visible sin backend (stock=0)
    const FALLBACK = [
      { id: 1, slug: "berry-blast",       name: "Berry Blast",       description: "Fresas, ar√°ndanos, frambuesas", price: 4990, color: "#ff6b6b", stock: 0, active: true },
      { id: 2, slug: "tropical-paradise", name: "Tropical Paradise", description: "Mango, pi√±a, maracuy√°",        price: 5490, color: "#ffd166", stock: 0, active: true },
      { id: 3, slug: "green-energy",      name: "Green Energy",      description: "Espinaca, pl√°tano, kiwi",       price: 5990, color: "#06d6a0", stock: 0, active: true },
      { id: 4, slug: "choco-protein",     name: "Choco Protein",     description: "Cacao con whey y almendras",    price: 6290, color: "#8b5cf6", stock: 0, active: true },
      { id: 5, slug: "matcha-boost",      name: "Matcha Boost",      description: "Matcha, pl√°tano y coco",        price: 5790, color: "#22c55e", stock: 0, active: true },
      { id: 6, slug: "pi√±a-colada-fit",   name: "Pi√±a Colada Fit",   description: "Pi√±a y coco sin az√∫car",        price: 5290, color: "#facc15", stock: 0, active: true },
    ];

    // ==========================
    // Descripciones personalizadas (para el modal)
    // ==========================
    const DESCRIPCIONES_PERSONALIZADAS = {
      "berry-blast": "Explosi√≥n de frutos rojos: frutillas, ar√°ndanos y frambuesas mezclados con yogur ligero para un smoothie fresco, dulce y lleno de antioxidantes.",
      "berry blast": "Explosi√≥n de frutos rojos: frutillas, ar√°ndanos y frambuesas mezclados con yogur ligero para un smoothie fresco, dulce y lleno de antioxidantes.",

      "tropical-paradise": "Una parada directa al tr√≥pico: mango maduro, pi√±a jugosa y maracuy√° natural. Refrescante, arom√°tico y perfecto para los d√≠as calurosos.",
      "tropical paradise": "Una parada directa al tr√≥pico: mango maduro, pi√±a jugosa y maracuy√° natural. Refrescante, arom√°tico y perfecto para los d√≠as calurosos.",

      "green-energy": "Combo verde energizante con espinaca fresca, pl√°tano y kiwi. Ideal para comenzar el d√≠a con fibra, vitaminas y un empuj√≥n natural de energ√≠a.",
      "green energy": "Combo verde energizante con espinaca fresca, pl√°tano y kiwi. Ideal para comenzar el d√≠a con fibra, vitaminas y un empuj√≥n natural de energ√≠a.",

      "choco-protein": "Smoothie cremoso de cacao real con prote√≠na whey, leche vegetal y toque de almendras. Perfecto como post-entrenamiento o snack saciante.",
      "choco protein": "Smoothie cremoso de cacao real con prote√≠na whey, leche vegetal y toque de almendras. Perfecto como post-entrenamiento o snack saciante.",

      "matcha-boost": "Shot de energ√≠a limpia con t√© matcha japon√©s, pl√°tano y leche de coco. Suave, arom√°tico y con cafe√≠na natural de liberaci√≥n sostenida.",
      "matcha boost": "Shot de energ√≠a limpia con t√© matcha japon√©s, pl√°tano y leche de coco. Suave, arom√°tico y con cafe√≠na natural de liberaci√≥n sostenida.",

      "pi√±a-colada-fit": "Versi√≥n liviana de la cl√°sica pi√±a colada: pi√±a natural y coco sin az√∫car a√±adida. Refrescante, tropical y amigable con tus objetivos fitness.",
      "pi√±a colada fit": "Versi√≥n liviana de la cl√°sica pi√±a colada: pi√±a natural y coco sin az√∫car a√±adida. Refrescante, tropical y amigable con tus objetivos fitness.",

      // Ejemplo para el que muestras en la captura:
      "jugo detox naranja & jengibre": "Jugo c√≠trico con naranja, lim√≥n y jengibre fresco para activar tu metabolismo y despertar tu energ√≠a de forma natural."
    };

    function descripcionPersonalizada(p){
      const slug = (p.slug || "").toLowerCase();
      const name = (p.name || "").toLowerCase();

      if (DESCRIPCIONES_PERSONALIZADAS[slug]) return DESCRIPCIONES_PERSONALIZADAS[slug];
      if (DESCRIPCIONES_PERSONALIZADAS[name]) return DESCRIPCIONES_PERSONALIZADAS[name];

      return p.description || "Smoothie natural preparado al momento con frutas frescas y sin az√∫car a√±adida.";
    }

    // ==========================
    // Detalles por smoothie (tabs √∫nicos)
    // ==========================
    const DETALLES_SMOOTHIES = {
      "berry-blast": {
        ingredientes: `
          <ul style="padding-left:1.1rem; line-height:1.9">
            <li>Frutillas frescas</li>
            <li>Ar√°ndanos</li>
            <li>Frambuesas</li>
            <li>Yogur descremado</li>
            <li>Hielo</li>
          </ul>`,
        beneficios: `
          <ul style="padding-left:1.1rem; line-height:1.9">
            <li>Alto contenido de antioxidantes</li>
            <li>Ayuda a proteger las c√©lulas del estr√©s oxidativo</li>
            <li>Ideal como snack dulce y liviano</li>
          </ul>`,
        nutricion: `
          <p>Calor√≠as aprox.: 190 kcal<br>
          Prote√≠nas: 7 g<br>
          Carbohidratos: 30 g<br>
          Grasas: 3 g<br>
          Fibra: 5 g</p>`
      },
      "tropical-paradise": {
        ingredientes: `
          <ul style="padding-left:1.1rem; line-height:1.9">
            <li>Mango maduro</li>
            <li>Pi√±a</li>
            <li>Maracuy√°</li>
            <li>Agua o leche vegetal</li>
            <li>Hielo</li>
          </ul>`,
        beneficios: `
          <ul style="padding-left:1.1rem; line-height:1.9">
            <li>Rico en vitamina C</li>
            <li>Favorece la digesti√≥n gracias a las enzimas de la pi√±a</li>
            <li>Refrescante e hidratante</li>
          </ul>`,
        nutricion: `
          <p>Calor√≠as aprox.: 210 kcal<br>
          Prote√≠nas: 3 g<br>
          Carbohidratos: 38 g<br>
          Grasas: 2 g<br>
          Fibra: 4 g</p>`
      },
      "green-energy": {
        ingredientes: `
          <ul style="padding-left:1.1rem; line-height:1.9">
            <li>Espinaca fresca</li>
            <li>Pl√°tano</li>
            <li>Kiwi</li>
            <li>Manzana verde</li>
            <li>Agua o leche vegetal</li>
          </ul>`,
        beneficios: `
          <ul style="padding-left:1.1rem; line-height:1.9">
            <li>Fuente de hierro y folatos</li>
            <li>Apoya el sistema inmune</li>
            <li>Aporta energ√≠a sostenida durante la ma√±ana</li>
          </ul>`,
        nutricion: `
          <p>Calor√≠as aprox.: 180 kcal<br>
          Prote√≠nas: 5 g<br>
          Carbohidratos: 32 g<br>
          Grasas: 2 g<br>
          Fibra: 6 g</p>`
      },
      "choco-protein": {
        ingredientes: `
          <ul style="padding-left:1.1rem; line-height:1.9">
            <li>Cacao puro</li>
            <li>Prote√≠na whey sabor chocolate</li>
            <li>Leche vegetal</li>
            <li>Almendras</li>
            <li>Hielo</li>
          </ul>`,
        beneficios: `
          <ul style="padding-left:1.1rem; line-height:1.9">
            <li>Alto aporte de prote√≠nas para recuperaci√≥n muscular</li>
            <li>Satisface antojos de algo dulce sin az√∫cares a√±adidos</li>
            <li>Ideal post-entrenamiento</li>
          </ul>`,
        nutricion: `
          <p>Calor√≠as aprox.: 230 kcal<br>
          Prote√≠nas: 20 g<br>
          Carbohidratos: 15 g<br>
          Grasas: 7 g<br>
          Fibra: 4 g</p>`
      },
      "matcha-boost": {
        ingredientes: `
          <ul style="padding-left:1.1rem; line-height:1.9">
            <li>T√© matcha japon√©s</li>
            <li>Pl√°tano</li>
            <li>Leche de coco</li>
            <li>Endulzante natural</li>
            <li>Hielo</li>
          </ul>`,
        beneficios: `
          <ul style="padding-left:1.1rem; line-height:1.9">
            <li>Fuente de cafe√≠na natural de liberaci√≥n lenta</li>
            <li>Aporta concentraci√≥n y foco</li>
            <li>Rico en antioxidantes (catequinas)</li>
          </ul>`,
        nutricion: `
          <p>Calor√≠as aprox.: 200 kcal<br>
          Prote√≠nas: 5 g<br>
          Carbohidratos: 28 g<br>
          Grasas: 6 g<br>
          Fibra: 3 g</p>`
      },
      "pi√±a-colada-fit": {
        ingredientes: `
          <ul style="padding-left:1.1rem; line-height:1.9">
            <li>Pi√±a natural</li>
            <li>Leche de coco light</li>
            <li>Agua</li>
            <li>Hielo</li>
          </ul>`,
        beneficios: `
          <ul style="padding-left:1.1rem; line-height:1.9">
            <li>Refrescante e hidratante</li>
            <li>Menor contenido cal√≥rico que una pi√±a colada tradicional</li>
            <li>Ideal para acompa√±ar planes de control de peso</li>
          </ul>`,
        nutricion: `
          <p>Calor√≠as aprox.: 170 kcal<br>
          Prote√≠nas: 2 g<br>
          Carbohidratos: 30 g<br>
          Grasas: 4 g<br>
          Fibra: 3 g</p>`
      },
      // Ejemplo para "Jugo Detox Naranja & Jengibre"
      "jugo detox naranja & jengibre": {
        ingredientes: `
          <ul style="padding-left:1.1rem; line-height:1.9">
            <li>Naranja fresca</li>
            <li>Lim√≥n</li>
            <li>Jengibre fresco</li>
            <li>Agua filtrada</li>
            <li>Hielo</li>
          </ul>`,
        beneficios: `
          <ul style="padding-left:1.1rem; line-height:1.9">
            <li>Ayuda a activar el metabolismo</li>
            <li>Apoya la digesti√≥n y sensaci√≥n de ligereza</li>
            <li>Aporte alto de vitamina C</li>
          </ul>`,
        nutricion: `
          <p>Calor√≠as aprox.: 90 kcal<br>
          Prote√≠nas: 2 g<br>
          Carbohidratos: 20 g<br>
          Grasas: 0 g<br>
          Fibra: 2 g</p>`
      }
    };

    function detallesDeProducto(p){
      const slug = (p.slug || "").toLowerCase();
      const name = (p.name || "").toLowerCase();
      if (DETALLES_SMOOTHIES[slug]) return DETALLES_SMOOTHIES[slug];
      if (DETALLES_SMOOTHIES[name]) return DETALLES_SMOOTHIES[name];
      return null;
    }

    function withTimeout(promise, ms = 3500) {
      return new Promise((resolve, reject) => {
        const t = setTimeout(() => reject(new Error("timeout")), ms);
        promise.then(v => { clearTimeout(t); resolve(v); })
               .catch(e => { clearTimeout(t); reject(e); });
      });
    }
    function saveCache(products){ try{ localStorage.setItem(CACHE_KEY, JSON.stringify(products)); localStorage.setItem(CACHE_TS_KEY, String(Date.now())); }catch{} }
    function loadCache(){ try{ const raw = localStorage.getItem(CACHE_KEY); return raw ? JSON.parse(raw) : null; }catch{ return null; } }

    // Toast simple
    function toast(msg, type='ok'){
      const t = document.createElement('div');
      t.className = 'toast' + (type==='error' ? ' error' : '');
      t.textContent = msg;
      document.body.appendChild(t);
      setTimeout(()=>t.remove(), 2000);
    }

    // ==========================
    // Data con fallback
    // ==========================
    async function obtenerProductos(){
      try{
        const res = await withTimeout(fetch(API_URL), 3500);
        if(!res.ok) throw new Error("backend not ok");
        const data = await res.json();
        saveCache(data);
        return { products: data, mode: "live" };
      }catch(e){
        const cache = loadCache();
        if(cache && cache.length){
          const demo = cache.map(p => ({...p, stock: 0}));
          return { products: demo, mode: "cache" };
        }
        return { products: FALLBACK, mode: "fallback" };
      }
    }

    function bannerHTML(mode){
      if(mode === "live") return "";
      const txt = mode === "cache"
        ? "Mostrando √∫ltimos productos guardados (offline). Stock deshabilitado."
        : "Backend no disponible. Modo demo: stock deshabilitado.";
      return `<div class="fallback-banner" style="margin:12px auto; max-width:960px; padding:10px 14px; background:#fff3cd; color:#4d3a00; border:1px solid #ffe69c; border-radius:8px; font-size:.95rem; text-align:center;">${txt}</div>`;
    }

    function renderBanner(mode){
      const section = document.querySelector(".smoothies-section");
      section.querySelector(".fallback-banner")?.remove();
      const html = bannerHTML(mode);
      if (!html) return;
      const wrapper = document.createElement("div");
      wrapper.innerHTML = html;
      section.prepend(wrapper.firstChild);
    }

    // ==========================
    // Filtro por tipo
    // ==========================
    function tipoProducto(p){
      const slug = (p.slug || "").toLowerCase();
      const nombre = (p.name || "").toLowerCase();

      if (slug.includes("detox") || nombre.includes("detox")) return "jugos_detox";
      if (slug.includes("proteico") || slug.includes("protein") || nombre.includes("proteico")) return "smoothies_proteicos";
      if (slug.includes("verde") || slug.includes("green") || nombre.includes("verde") || nombre.includes("green")) return "smoothies_verdes";

      // resto = frutales
      return "smoothies_frutales";
    }

    // ==========================
    // Cards (descripci√≥n corta)
    // ==========================
    function cardHTML(p){
      const disabled = (p.stock ?? 0) <= 0;
      const desc = p.description || ""; // breve, como antes
      return `
        <div class="smoothie-card" data-id="${p.id}">
          <div class="smoothie-color" data-role="open" style="background:${p.color}"></div>
          <div class="smoothie-info">
            <h3 class="smoothie-name" data-role="open">${p.name}</h3>
            <p class="smoothie-desc">${desc}</p>
            <p class="smoothie-price">${CLP.format(p.price)}</p>
            <button class="add-to-cart" data-role="add" ${disabled ? "disabled" : ""}>
              ${disabled ? "Sin stock" : "Agregar al Carrito"}
            </button>
          </div>
        </div>
      `;
    }

    function renderGrid(products){
      const grid = document.getElementById('smoothies-grid');

      if (!products || !products.length) {
        grid.innerHTML = `<p>No se encontraron productos para los filtros aplicados.</p>`;
        return;
      }

      grid.innerHTML = products.map(cardHTML).join("");

      // Wire eventos por tarjeta
      grid.querySelectorAll(".smoothie-card").forEach(card=>{
        const id = Number(card.dataset.id);

        card.querySelectorAll('[data-role="open"]').forEach(el=>{
          el.addEventListener('click', ev=>{
            ev.stopPropagation();
            const p = ALL_PRODUCTS.find(x=>x.id===id);
            if(p) abrirModal(p);
          });
        });

        const btnAdd = card.querySelector('[data-role="add"]');
        if (btnAdd) {
          btnAdd.addEventListener('click', ev=>{
            ev.stopPropagation();
            const p = ALL_PRODUCTS.find(x=>x.id===id);
            if(!p) return;
            if((p.stock ?? 0) <= 0) return; // deshabilitado en demo
            agregarAlCarrito({ id:p.id, name:p.name, price:p.price });
          });
        }
      });
    }

    function aplicarFiltros(){
      if (!ALL_PRODUCTS || !ALL_PRODUCTS.length) return;

      const input = document.getElementById('search');
      const typeSel = document.getElementById('filter-type');

      const texto = (input.value || "").toLowerCase().trim();
      const tipo = typeSel.value;

      const filtrados = ALL_PRODUCTS.filter(p=>{
        const name = (p.name || "").toLowerCase();
        const desc = descripcionPersonalizada(p).toLowerCase(); // b√∫squeda sobre texto largo

        const coincideTexto =
          !texto ||
          name.includes(texto) ||
          desc.includes(texto);

        const coincideTipo =
          tipo === "all" ||
          tipoProducto(p) === tipo;

        return coincideTexto && coincideTipo;
      });

      renderGrid(filtrados);
    }

    // ==========================
    // Cargar cat√°logo
    // ==========================
    async function cargarProductos(){
      const grid = document.getElementById('smoothies-grid');
      grid.innerHTML = `<p>Cargando smoothies...</p>`;

      const { products, mode } = await obtenerProductos();
      ALL_PRODUCTS = products;
      MODE_PRODUCTS = mode;

      renderBanner(mode);
      aplicarFiltros(); // usa ALL_PRODUCTS + filtros actuales
    }

    // ==========================
    // Modal
    // ==========================
    function abrirModal(p){
      CURRENT_PRODUCT = p; // guardamos para las tabs

      document.getElementById('modal-nombre').textContent = p.name;
      document.getElementById('modal-precio').textContent = CLP.format(p.price);
      document.getElementById('modal-descripcion').textContent = descripcionPersonalizada(p);
      const stockEl = document.getElementById('modal-stock');
      stockEl.textContent = (p.stock ?? 0) > 0 ? ` Disponible: ${p.stock}` : ' Sin stock';
      stockEl.style.background = (p.stock ?? 0) > 0 ? '#14532d' : '#7f1d1d';
      document.getElementById('modal-imagen').style.background = p.color;

      mostrarTab('ingredientes');

      const btn = document.getElementById('modal-add');
      btn.disabled = (p.stock ?? 0) <= 0;
      btn.textContent = (p.stock ?? 0) > 0 ? 'Agregar al Carrito' : 'Sin stock';
      btn.onclick = () => {
        if((p.stock ?? 0) <= 0) return;
        agregarAlCarrito({ id:p.id, name:p.name, price:p.price });
        document.getElementById('modal-detalle').classList.add('hidden');
      };

      document.getElementById('modal-detalle').classList.remove('hidden');
    }

    document.getElementById('modal-cerrar').addEventListener('click', ()=>{
      document.getElementById('modal-detalle').classList.add('hidden');
      CURRENT_PRODUCT = null;
    });

    function mostrarTab(tab){
      const contenido = document.getElementById('tab-contenido');
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      document.querySelector(`.tab[data-tab="${tab}"]`).classList.add('active');

      const p = CURRENT_PRODUCT;
      const detalles = p ? detallesDeProducto(p) : null;

      if(detalles && detalles[tab]){
        contenido.innerHTML = detalles[tab];
        return;
      }

      // Fallback gen√©rico si no definimos ese smoothie a√∫n
      if(tab==='ingredientes'){
        contenido.innerHTML = `<ul style="padding-left:1.1rem; line-height:1.9">
          <li>Fruta fresca de temporada</li>
          <li>L√≠quido base (agua o leche vegetal)</li>
          <li>Hielo</li>
        </ul>`;
      }else if(tab==='beneficios'){
        contenido.innerHTML = `<ul style="padding-left:1.1rem; line-height:1.9">
          <li>Aporte natural de vitaminas y minerales</li>
          <li>Ideal como snack o desayuno ligero</li>
          <li>Preparado al momento</li>
        </ul>`;
      }else{
        contenido.innerHTML = `<p>Calor√≠as aprox.: 180‚Äì220 kcal<br>
          Prote√≠nas: 2‚Äì7 g<br>
          Carbohidratos: 25‚Äì40 g<br>
          Grasas: 1‚Äì7 g<br>
          Fibra: 3‚Äì6 g</p>`;
      }
    }

    document.addEventListener('click', (e)=>{
      const t = e.target.closest('.tab');
      if(t) mostrarTab(t.dataset.tab);
    });

    // ==========================
    // Carrito (localStorage)
    // ==========================
    function agregarAlCarrito(prod){
      const key='carrito';
      const carrito = JSON.parse(localStorage.getItem(key) || '[]');
      const i = carrito.findIndex(p=>p.id===prod.id);
      if(i>=0) carrito[i].qty += 1;
      else carrito.push({...prod, qty:1});
      localStorage.setItem(key, JSON.stringify(carrito));
      toast(`‚úÖ ${prod.name} agregado al carrito`);
    }

    // ==========================
    // Start
    // ==========================
    document.addEventListener('DOMContentLoaded', ()=>{
      renderSessionUI();
      const input = document.getElementById('search');
      const typeSel = document.getElementById('filter-type');
      input.addEventListener('input', aplicarFiltros);
      typeSel.addEventListener('change', aplicarFiltros);
      cargarProductos();
    });
  </script>
</body>
</html>
